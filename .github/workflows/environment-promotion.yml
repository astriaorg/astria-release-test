name: Environment Promotion

# Global variables
env:
  # Controls how many commits to fetch when checking out the repository
  # This is optimized to keep checkouts fast while ensuring we have enough history
  # to find the relevant tags for environment promotions
  GIT_FETCH_DEPTH: 50
  # Number of characters to use for shortened git commit hashes
  # 8 characters is typically enough to ensure uniqueness while keeping hashes readable
  GIT_HASH_LENGTH: 7
  # Charts repository where deployment manifests are stored
  CHARTS_REPO: astriaorg/charts-release-test

on:
  # Manual trigger for promotions
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to promote to'
        required: true
        type: choice
        options:
          - devnet
          - testnet
          - mainnet
      commit_sha:
        description: 'Commit SHA to promote'
        required: true
        type: string
      force_version:
        description: 'Force a specific version (optional, e.g., v1.2.3-preview)'
        required: false
        type: string

# Limit permissions to minimum required
permissions:
  contents: write  # For tagging
  id-token: write  # For authenticating to cloud providers

jobs:
  # Security check for event source and pull request forks
  security_check:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ github.event_name == 'workflow_dispatch' }}
    steps:
      - run: echo "Security check passed - manual workflow dispatch"

  determine-commit:
    needs: security_check
    if: needs.security_check.outputs.should_run
    uses: ./.github/workflows/reusable-determine-commit.yml
    with:
      environment: ${{ github.event.inputs.environment }}
      commit_sha: ${{ github.event.inputs.commit_sha }}
      force_version: ${{ github.event.inputs.force_version }}
      mode: "commit"  # Use the new commit-based mode

  sync-charts:
    needs: determine-commit
    if: needs.determine-commit.outputs.components_with_charts != '[]'
    uses: ./.github/workflows/reusable-sync-charts.yml
    with:
      environment: ${{ github.event.inputs.environment }}
      commit_sha: ${{ needs.determine-commit.outputs.commit_sha }}
      promotion_version: ${{ needs.determine-commit.outputs.version }}
      components_with_charts: ${{ needs.determine-commit.outputs.components_with_charts }}
    secrets:
      CHARTS_REPO_TOKEN: ${{ secrets.CHARTS_REPO_TOKEN }}

  promote:
    needs: sync-charts
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Display promotion details
        run: |
          echo "ðŸš€ Promoting commit ${{ needs.determine-commit.outputs.commit_sha }} to ${{ github.event.inputs.environment }}"
          echo ""
          echo "**Promotion Details:**"
          echo "- Commit: ${{ needs.determine-commit.outputs.commit_sha }}"
          echo "- Version: ${{ needs.determine-commit.outputs.version }}"
          echo "- Environment: ${{ github.event.inputs.environment }}"
          echo "- Changed components: ${{ needs.determine-commit.outputs.changed_components }}"
          echo "- Components with charts: ${{ needs.determine-commit.outputs.components_with_charts }}"
          echo ""

      - name: Environment verification
        run: |
          echo "ðŸ§ª Running verification for ${{ github.event.inputs.environment }}"
          echo "âœ… Environment verification passed"

      - name: Promotion summary
        run: |
          echo "ðŸŽ‰ Promotion completed!"
          echo ""
          echo "**Summary:**"
          echo "- Environment: ${{ github.event.inputs.environment }}"
          echo "- Commit: ${{ needs.determine-commit.outputs.commit_sha }}"
          echo "- Version: ${{ needs.determine-commit.outputs.version }}"

          COMPONENTS_WITH_CHARTS='${{ needs.determine-commit.outputs.components_with_charts }}'
          if [[ "$COMPONENTS_WITH_CHARTS" != "[]" ]]; then
            echo "- Charts updated for: $(echo '$COMPONENTS_WITH_CHARTS' | jq -r '.[]' | tr '\n' ' ')"
          else
            echo "- No charts updated (no components with charts detected)"
          fi